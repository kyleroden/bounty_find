#!/usr/bin/env node
'use strict';

const current_date = new Date();

//check to make sure this is working from heroku server
console.log("date variable from server: ", current_date);

const request = require('superagent');
const pg = require('pg');

request.get('http://biketownpdx.socialbicycles.com/opendata/free_bike_status.json')
    .set('Accept', 'application/json')
    .end(function(err, res) {
      if(err) {
        console.log("error: ", err);
      }
      let current_bounty_inventory = res.body.data.bikes;
      let bike_total = current_bounty_inventory.length;
      console.log("inventory: ", bike_total);

      //store the data in the db
      pg.connect(process.env.DATABASE_URL || 'bikebounties://localhost:5000', function(err, client, done) {
          client.query('INSERT INTO bounties values(' + CURRENT_TIMESTAMP + ', ' + "'" + bike_total + "'" + ')',
              function(err, result) {
                  done();
                  if (err) {
                      console.error(err);
                      //result.send("ERROR ", err);
                  } else {

                  }
                  client.end();
                });
      });
    });
